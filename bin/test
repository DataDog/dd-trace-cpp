#!/bin/sh

set -e

MAKE_JOB_COUNT=${MAKE_JOB_COUNT:-$(nproc)}

if [ "$1" = '--coverage' ]; then
    enable_coverage=1
    cmake_preset=coverage
    shift
else
    enable_coverage=0
    cmake_preset='default'
fi

if [ "$1" = '--verbose' ]; then
    verbosity_flags='-v'
    shift
else
    verbosity_flags=''
fi

if [ "$1" = '--show-coverage' ]; then
    # implies --coverage
    cmake_preset=coverage
    show_coverage=1
    shift
else
    show_coverage=0
fi

if [ "$1" = '--build-only' ]; then
    build_only=1
else
    build_only=0
fi

cd "$(dirname "$0")"/..

# shellcheck disable=SC2086
cmake --preset "${cmake_preset}" -B .build
# Clean up any code coverage artifacts.
find . -type f -name '*.gcda' -print0 | xargs -0 rm -f
# shellcheck disable=SC2086
cmake --build .build -j "$MAKE_JOB_COUNT" $verbosity_flags

if [ "$build_only" -eq 1 ]; then
    exit
fi

echo 'Running tests...'
./.build/test/tests "$@"

if [ "$enable_coverage" != '' ]; then
    printf 'Generating Code Coverage Report ... '
    rm -rf .coverage
    mkdir -p .coverage

    # Read files to filter out from the coverage report.
    files_to_ignore=""
    while IFS= read -r line || [ -n "$line" ]; do
        # Skip empty lines and comments
        case "$line" in
            ''|\#*) continue ;;
        esac

        case "$line" in
            /*) full="$line" ;;
            *)  full="$(pwd)/$line" ;;
        esac

        # Quote each full path and add to args
        files_to_ignore="$files_to_ignore $full"
    done < ".lcovignore"

    # Compile the .gcdo files into an intermediate format.
    # Use the faster JSON Perl module, JSON:XS, to speed things up.
    lcov --quiet --capture --directory .build --output-file .coverage/raw.info --rc geninfo_json_module=JSON::XS
    # Filter out system headers and test drivers.
    # shellcheck disable=SC2086
    lcov --quiet --remove .coverage/raw.info -o .coverage/filtered.info $files_to_ignore
    echo 'Done.'
fi

if [ "$show_coverage" -eq 1 ]; then
    # Generate an HTML coverage report at ".coverage/report/index.html".
    genhtml --quiet --dark-mode .coverage/filtered.info --output-directory .coverage/report

    index='.coverage/report/index.html'
    case "$(uname -s)" in
      Darwin) open "$index" ;;
      Windows*|CYGWIN*) explorer "$index" ;;
      *) xdg-open "$index" ;;
    esac
fi
